<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OdontoBook | Pro Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --primary: #0f4c75; 
            --accent: #3282b8; 
            --mint: #27ae60;
            --bg: #f0f4f8; 
            --white: #ffffff; 
            --danger: #e74c3c; 
            --sidebar-color: #1b262c;
            --warning: #f39c12;
            --text-main: #2c3e50;
        }

        * { box-sizing: border-box; transition: background 0.2s, color 0.2s, transform 0.2s; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            overflow: hidden; 
            touch-action: none; 
            height: 100vh;
        }

        .screen { display: none; height: 100vh; width: 100vw; overflow: hidden; }
        .active { display: flex; }

        /* --- RESPONSIVIDADE GERAL --- */
        @media (max-width: 768px) {
            .active { flex-direction: column; }
            #sidebar { 
                width: 100% !important; 
                height: auto !important; 
                padding: 10px 15px !important; 
                flex-direction: row !important; 
                align-items: center;
                justify-content: space-between; 
                gap: 10px !important;
            }
            .clock-box { display: none; }
            .logo-area h1 { font-size: 14px; margin: 0; }
            .logo-area img { height: 45px; width: auto; }
            .notebook-grid { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important; 
                gap: 20px !important; 
                padding: 20px !important;
            }
            .nb-container { width: 100px !important; }
            .nb-book { height: 130px !important; }
        }

        /* BOTÕES */
        .btn { 
            border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; 
            font-weight: 700; font-size: 11px; display: inline-flex; align-items: center; 
            justify-content: center; text-transform: uppercase; letter-spacing: 0.8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); gap: 8px; flex-shrink: 0;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-mint { background: var(--mint); color: white; }
        .btn-dark { background: var(--sidebar-color); color: white; }
        .btn-light { background: #e2e8f0; color: #475569; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: #475569; }

        /* SIDEBAR PC */
        #sidebar { 
            width: 280px; background: var(--sidebar-color); padding: 30px 20px; 
            display: flex; flex-direction: column; gap: 20px; color: white;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100;
        }

        /* ÁREA DA LOGO (MOVIDA PARA BAIXO VIA FLEX NO SIDEBAR) */
        .logo-area { text-align: center; margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .logo-area img { 
            max-width: 120px; max-height: 120px; object-fit: contain;
            border-radius: 10px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            margin-bottom: 10px;
        }
        .logo-area h1 { font-size: 18px; margin: 5px 0 0 0; font-family: 'Plus Jakarta Sans', sans-serif; }

        .clock-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 10px; }
        #clock { font-size: 24px; font-weight: 800; color: #ffffff; display: block; line-height: 1.2; }
        #date-sidebar { font-size: 14px; color: rgba(255,255,255,0.7); display: block; }

        /* GRID DE MATÉRIAS */
        .notebook-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 40px; padding: 40px; }
        .nb-container { display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; width: 140px; }
        .nb-book {
            width: 100%; height: 180px; border-radius: 4px 14px 14px 4px;
            position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-left: 10px solid rgba(0,0,0,0.3); background: #34495e;
            background-size: cover; background-position: center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nb-container:hover .nb-book { transform: translateY(-8px) rotate(-2deg); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .nb-title-label { font-size: 12px; font-weight: 800; color: var(--sidebar-color); text-align: center; text-transform: uppercase; width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; letter-spacing: 0.5px; }

        /* EDITOR / PAPER */
        #paper-wrapper { flex-grow: 1; padding: 20px; overflow: auto; display: flex; justify-content: center; background: #cfd8dc; position: relative; }
        #paper-container { 
            position: relative; width: 800px; min-height: 1035px; 
            background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            overflow: visible; transform-origin: top center; margin-bottom: 50px;
        }
        .pautada { background-image: linear-gradient(#d1e1f0 1.5px, transparent 1.5px); background-size: 100% 31px; background-position: 0 115px; }
        .margem-vermelha { position: absolute; left: 65px; top: 0; bottom: 0; width: 2px; background: rgba(255, 50, 50, 0.25); z-index: 1; }
        
        #text-editor { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding: 135px 40px 40px 80px; line-height: 31px; font-size: 18px; 
            border: none; background: transparent; outline: none; resize: none; 
            z-index: 5; font-family: 'Plus Jakarta Sans', sans-serif; color: #2c3e50; 
        }
        
        canvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        
        #eraser-cursor {
            width: 40px; height: 40px; border: 2px solid #e74c3c;
            background: rgba(231, 76, 60, 0.2); border-radius: 50%;
            position: fixed; pointer-events: none; display: none; z-index: 10000;
            transform: translate(-50%, -50%);
        }

        .header-folha { position: absolute; top: 20px; left: 80px; right: 40px; display: flex; justify-content: space-between; align-items: center; z-index: 2; }
        .arte-lembretes { display: none; flex-direction: column; align-items: center; }
        .lembrete-active .arte-lembretes { display: flex; }
        .lembrete-active #tit-pg, .lembrete-active #data-pg-display { display: none !important; }
        .fonte-moderna { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 32px; letter-spacing: -1.5px; text-transform: uppercase; background: linear-gradient(to bottom, #1b262c, #0f4c75); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .tabs-row { display: flex; align-items: center; background: #cbd5e0; padding: 10px 10px 0; gap: 5px; overflow-x: auto; white-space: nowrap; }
        .tab { padding: 10px 15px; background: #e2e8f0; color: #64748b; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 10px; font-weight: 800; border: none; text-transform: uppercase; }
        .tab.active { background: white; color: var(--primary); }

        #images-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; pointer-events: none; }
        .img-obj { position: absolute; cursor: move; border: 2px solid transparent; pointer-events: auto; outline: none; }
        .img-obj img { width: 100%; height: 100%; display: block; pointer-events: none; user-select: none; }
        .resizer { width: 30px; height: 30px; background: var(--accent); position: absolute; right: -15px; bottom: -15px; cursor: nwse-resize; border-radius: 50%; border: 3px solid white; display: none; z-index: 30; }
        .btn-del-img { position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: var(--danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; border: 2px solid white; z-index: 31; }
        .img-obj.selected { border: 2px dashed var(--accent); }
        .img-obj.selected .resizer, .img-obj.selected .btn-del-img { display: flex; }

        .color-picker-wrapper { position: relative; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .color-picker-wrapper input { position: absolute; width: 100%; height: 100%; cursor: pointer; opacity: 0; }
        
        .floating-actions { position: fixed; bottom: 25px; right: 25px; display: flex; gap: 10px; z-index: 200; }

        /* MODAIS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 15px; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; }
        .config-item { display: flex; flex-direction: column; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
        @media (min-width: 600px) { .config-item { flex-direction: row; justify-content: space-between; align-items: center; } }
        .config-actions { display: flex; gap: 5px; flex-wrap: wrap; }

        .m-tab { cursor: pointer; padding: 8px 12px; border-radius: 8px; font-weight: 800; color: #94a3b8; font-size: 11px; text-transform: uppercase; }
        .m-tab.active { background: var(--primary); color: white; }

        .btn-draw-active { background: var(--warning) !important; color: white !important; }
        .btn-eraser-active { background: var(--danger) !important; color: white !important; }
        
        .trash-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff1f0; border: 1px solid #ffa39e; border-radius: 10px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="eraser-cursor"></div>

    <input type="file" id="coverInput" hidden accept="image/*" onchange="handleCoverFile(event)">
    <input type="file" id="logoInput" hidden accept="image/*" onchange="handleLogoFile(event)">

    <div id="home-screen" class="screen active">
        <aside id="sidebar">
            <div class="clock-box">
                <span id="clock">00:00</span>
                <span id="date-sidebar">00/00/0000</span>
            </div>
            
            <button class="btn btn-accent" onclick="addNB()">+ Matéria</button>
            <button class="btn btn-outline" style="color:white; border-color:rgba(255,255,255,0.2);" onclick="openConfig()">Ajustes</button>

            <div class="logo-area" id="logo-display-area">
                <img id="main-logo-img" src="https://i.ibb.co/C3X1H7R/LOGO-VERTOR.jpg" alt="Logo">
                <h1>OdontoBook <span style="color:var(--mint)">PRO</span></h1>
            </div>
        </aside>

        <main style="flex-grow: 1; overflow-y: auto; background: var(--bg);">
            <h2 style="color:var(--primary); padding: 30px 0 0 40px; margin: 0; font-weight: 800;">Minhas Matérias</h2>
            <div class="notebook-grid" id="grid-nb"></div>
        </main>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h3 style="margin:0; color:var(--primary); font-weight: 800;">Configurações</h3>
                <button class="btn btn-light" onclick="closeConfig()">FECHAR</button>
            </div>
            <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; overflow-x: auto;">
                <div id="tab-manage" class="m-tab active" onclick="switchConfigTab('manage')">Gerenciar</div>
                <div id="tab-personalize" class="m-tab" onclick="switchConfigTab('personalize')">Aparência</div>
                <div id="tab-trash" class="m-tab" onclick="switchConfigTab('trash')">Lixeira</div>
                <div id="tab-backup" class="m-tab" onclick="switchConfigTab('backup')">Backup</div>
            </div>

            <div id="config-manage-view">
                <div id="config-list"></div>
            </div>

            <div id="config-personalize-view" style="display:none">
                <div class="config-item">
                    <div>
                        <span style="font-weight:700; display:block">Logo Principal</span>
                        <small style="color:#64748b">Altere a imagem exibida no menu lateral.</small>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('logoInput').click()">Mudar Logo</button>
                </div>
            </div>

            <div id="config-trash-view" style="display:none">
                <div id="trash-list"></div>
            </div>

            <div id="config-backup-view" style="display:none;">
                <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="exportBackup()">Exportar Backup</button>
                <button class="btn btn-accent" style="width:100%;" onclick="document.getElementById('importFile').click()">Importar Backup</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importBackup(event)">
            </div>
        </div>
    </div>

    <div id="modal-pdf-select" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="color:var(--primary); font-weight: 800; margin-top:0;">Exportar PDF</h3>
            <p style="font-size: 12px; color: #666;">Selecione as páginas que deseja incluir:</p>
            <div id="pdf-pages-list" style="margin: 20px 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px;"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-light" style="flex:1" onclick="closePdfModal()">CANCELAR</button>
                <button class="btn btn-mint" style="flex:1" onclick="processPDF()">GERAR PDF</button>
            </div>
        </div>
    </div>

    <div id="editor-screen" class="screen" style="flex-direction: column;">
        <div id="top-bar" style="background:white; padding:10px; display:flex; align-items:center; gap:8px; border-bottom:1px solid #e2e8f0; z-index: 150;">
            <button class="btn btn-light" onclick="goToHome()">Início</button>
            <div style="display:flex; gap:2px;">
                <button class="btn btn-light" style="padding: 10px;" onclick="undo()" title="Retornar">⟲</button>
                <button class="btn btn-light" style="padding: 10px;" onclick="redo()" title="Avançar">⟳</button>
            </div>
            <button class="btn btn-light" id="btnDrawTool" onclick="toggleDrawingMode()">Caneta</button>
            <div class="color-picker-wrapper">
                <input type="color" id="penColor" value="#0f4c75" oninput="updateColorIcon(this.value)">
                <div id="color-preview" style="width:20px; height:20px; border-radius:5px; background:#0f4c75"></div>
            </div>
            <button class="btn btn-light" id="eraserBtn" onclick="toggleEraser()">Borracha</button>
            <button class="btn btn-dark" onclick="document.getElementById('imgInput').click()">+ Imagem</button>
            <input type="file" id="imgInput" hidden accept="image/*" onchange="handleImg(event)">
            <button class="btn btn-mint" style="margin-left:auto" onclick="openPdfModal()">PDF</button>
        </div>
        <div class="tabs-row" id="tabs"></div>
        <div id="paper-wrapper">
            <div id="paper-container" class="pautada" onmousedown="deselectImg(event)" ontouchstart="deselectImg(event)">
                <div class="margem-vermelha"></div>
                <div id="header-container" class="header-folha">
                    <div class="titulo-pg" id="tit-pg" style="font-weight: 800; color: var(--primary);">PÁGINA</div>
                    <div class="arte-lembretes"><div class="fonte-moderna">LEMBRETES</div></div>
                    <div id="data-pg-display" style="font-weight: 800; color: var(--primary); font-size: 14px;"></div>
                </div>
                <textarea id="text-editor" spellcheck="false"></textarea>
                <canvas id="drawingCanvas"></canvas>
                <div id="images-layer"></div>
            </div>
        </div>
        <div class="floating-actions">
            <button class="btn btn-dark" onclick="addPG()">+ Página</button>
            <button class="btn btn-danger" id="btnDelPG" onclick="delPG()">Excluir</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('odonto_v230')) || { 
            notebooks: [], 
            trash: { notebooks: [], pages: [] },
            customLogo: null 
        };
        if(!db.trash) db.trash = { notebooks: [], pages: [] };

        let curNB = null, curPG = 0, modeDraw = false, isEraser = false, isDrawing = false, selectedImg = null;
        let undoStack = [], redoStack = [];

        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const paper = document.getElementById('paper-container');
        const paperWrapper = document.getElementById('paper-wrapper');
        const eraserCursor = document.getElementById('eraser-cursor');

        function loadLogo() {
            if(db.customLogo) document.getElementById('main-logo-img').src = db.customLogo;
        }
        loadLogo();

        function adjustZoom() {
            const wrapperWidth = paperWrapper.clientWidth - 40;
            const targetWidth = 800;
            if (wrapperWidth < targetWidth) {
                const scale = wrapperWidth / targetWidth;
                paper.style.transform = `scale(${scale})`;
                paper.style.marginBottom = `-${(1035 * (1 - scale))}px`;
            } else {
                paper.style.transform = `scale(1)`;
                paper.style.marginBottom = `50px`;
            }
        }
        window.addEventListener('resize', adjustZoom);

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('date-sidebar').innerText = now.toLocaleDateString('pt-BR');
        }
        setInterval(updateClock, 1000); updateClock();

        function toggleDrawingMode() { modeDraw = !modeDraw; isEraser = false; updateToolStyles(); }
        function toggleEraser() { isEraser = !isEraser; if(isEraser) modeDraw = true; updateToolStyles(); }
        
        function updateToolStyles() {
            canvas.style.pointerEvents = modeDraw ? 'auto' : 'none';
            document.getElementById('btnDrawTool').classList.toggle('btn-draw-active', modeDraw && !isEraser);
            document.getElementById('eraserBtn').classList.toggle('btn-eraser-active', isEraser);
        }

        function saveHistory() { undoStack.push(canvas.toDataURL()); redoStack = []; }
        function undo() { if(undoStack.length) { redoStack.push(canvas.toDataURL()); applyHistory(undoStack.pop()); } }
        function redo() { if(redoStack.length) { undoStack.push(canvas.toDataURL()); applyHistory(redoStack.pop()); } }
        
        function applyHistory(src) { let img = new Image(); img.onload = () => { ctx.clearRect(0,0,800,1035); ctx.drawImage(img,0,0); }; img.src = src; }

        function getCoords(e) {
            const r = canvas.getBoundingClientRect();
            const scale = r.width / 800;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - r.left) / scale, y: (clientY - r.top) / scale };
        }

        canvas.onpointerdown = (e) => { if(!modeDraw) return; saveHistory(); isDrawing = true; const pos = getCoords(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };

        window.onpointermove = (e) => { 
            if(!isDrawing || !modeDraw) return; 
            const pos = getCoords(e);
            if(isEraser) {
                eraserCursor.style.display = 'block';
                eraserCursor.style.left = (e.touches ? e.touches[0].clientX : e.clientX) + 'px';
                eraserCursor.style.top = (e.touches ? e.touches[0].clientY : e.clientY) + 'px';
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 40;
            } else {
                eraserCursor.style.display = 'none';
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = 2;
                ctx.strokeStyle = document.getElementById('penColor').value;
            }
            ctx.lineTo(pos.x, pos.y); ctx.lineCap = 'round'; ctx.stroke(); 
        };

        window.onpointerup = () => { if(isDrawing) { isDrawing = false; eraserCursor.style.display = 'none'; saveCur(); } };

        function handleImg(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => { createImgObj({ src: f.target.result, x: 100, y: 150, w: 250, h: 250 }); saveCur(); };
            reader.readAsDataURL(file);
        }

        function createImgObj(data) {
            const div = document.createElement('div');
            div.className = 'img-obj'; 
            div.style.left = data.x + 'px'; div.style.top = data.y + 'px';
            div.style.width = data.w + 'px'; div.style.height = data.h + 'px';
            div.innerHTML = `<div class="btn-del-img">✕</div><img src="${data.src}"><div class="resizer"></div>`;
            const resizer = div.querySelector('.resizer');
            const btnDel = div.querySelector('.btn-del-img');
            div.onpointerdown = (e) => {
                if (modeDraw) return;
                if (e.target === resizer || e.target === btnDel) return;
                e.stopPropagation();
                if (selectedImg) selectedImg.classList.remove('selected');
                selectedImg = div;
                div.classList.add('selected');
                let startPos = getCoords(e);
                let startLeft = parseInt(div.style.left);
                let startTop = parseInt(div.style.top);
                const moveHandler = (ev) => {
                    let nowPos = getCoords(ev);
                    div.style.left = (startLeft + (nowPos.x - startPos.x)) + 'px';
                    div.style.top = (startTop + (nowPos.y - startPos.y)) + 'px';
                };
                const upHandler = () => {
                    document.removeEventListener('pointermove', moveHandler);
                    document.removeEventListener('pointerup', upHandler);
                    saveCur();
                };
                document.addEventListener('pointermove', moveHandler);
                document.addEventListener('pointerup', upHandler);
            };
            resizer.onpointerdown = (e) => {
                e.stopPropagation();
                let startW = div.offsetWidth;
                let startH = div.offsetHeight;
                let startPos = getCoords(e);
                const moveResizer = (ev) => {
                    let nowPos = getCoords(ev);
                    div.style.width = (startW + (nowPos.x - startPos.x)) + 'px';
                    div.style.height = (startH + (nowPos.y - startPos.y)) + 'px';
                };
                const stopResizer = () => {
                    document.removeEventListener('pointermove', moveResizer);
                    document.removeEventListener('pointerup', stopResizer);
                    saveCur();
                };
                document.addEventListener('pointermove', moveResizer);
                document.addEventListener('pointerup', stopResizer);
            };
            btnDel.onpointerdown = (e) => {
                e.stopPropagation();
                if(confirm("Excluir imagem?")) { div.remove(); saveCur(); }
            };
            document.getElementById('images-layer').appendChild(div);
        }

        function deselectImg(e) {
            if (selectedImg && !e.target.closest('.img-obj')) {
                selectedImg.classList.remove('selected');
                selectedImg = null;
            }
        }

        function saveDB() { localStorage.setItem('odonto_v230', JSON.stringify(db)); }
        function saveCur() {
            if(curNB === null) return;
            const imgs = []; 
            document.querySelectorAll('.img-obj').forEach(el => {
                imgs.push({ 
                    src: el.querySelector('img').src, 
                    x: parseInt(el.style.left), y: parseInt(el.style.top), 
                    w: parseInt(el.style.width), h: parseInt(el.style.height) 
                });
            });
            db.notebooks[curNB].pages[curPG].text = document.getElementById('text-editor').value;
            db.notebooks[curNB].pages[curPG].drawing = canvas.toDataURL();
            db.notebooks[curNB].pages[curPG].images = imgs; 
            saveDB();
        }

        function openNB(i) {
            curNB = i; curPG = 0; 
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('editor-screen').classList.add('active'); 
            canvas.width = 800; canvas.height = 1035;
            loadPG(); renderTabs(); setTimeout(adjustZoom, 100);
        }

        function loadPG() {
            let pg = db.notebooks[curNB].pages[curPG];
            document.getElementById('text-editor').value = pg.text || "";
            document.getElementById('tit-pg').innerText = pg.name;
            document.getElementById('data-pg-display').innerText = pg.dateCreation || "";
            
            const isLembrete = pg.name === "LEMBRETES";
            paper.classList.toggle('lembrete-active', isLembrete);
            document.getElementById('btnDelPG').disabled = isLembrete;

            ctx.clearRect(0,0,800,1035);
            if(pg.drawing) { 
                let img = new Image(); img.onload = () => ctx.drawImage(img,0,0); img.src = pg.drawing; 
            }
            document.getElementById('images-layer').innerHTML = '';
            if(pg.images) pg.images.forEach(img => createImgObj(img));
            undoStack = []; redoStack = [];
        }

        function addNB() { 
            let n = prompt("Nome da Matéria:"); 
            if(n) { 
                db.notebooks.push({ 
                    name: n, 
                    pages: [{ name: "LEMBRETES", text: "", dateCreation: new Date().toLocaleDateString('pt-BR') }] 
                }); 
                saveDB(); renderHome(); 
            } 
        }

        function addPG() { 
            saveCur(); 
            db.notebooks[curNB].pages.push({ 
                name: `Pág ${db.notebooks[curNB].pages.length}`, 
                text: "", dateCreation: new Date().toLocaleDateString('pt-BR') 
            }); 
            curPG = db.notebooks[curNB].pages.length-1; 
            loadPG(); renderTabs(); 
        }
        
        function delPG() { 
            if(db.notebooks[curNB].pages[curPG].name === "LEMBRETES") return;
            if(confirm("Mover página para lixeira?")) { 
                db.trash.pages.push({ pg: db.notebooks[curNB].pages[curPG], sourceNBName: db.notebooks[curNB].name }); 
                db.notebooks[curNB].pages.splice(curPG, 1); 
                curPG = 0; saveDB(); loadPG(); renderTabs(); 
            } 
        }

        function renderHome() {
            document.getElementById('grid-nb').innerHTML = db.notebooks.map((nb, i) => `
                <div class="nb-container" onclick="openNB(${i})">
                    <div class="nb-book" ${nb.customCover ? `style="background-image:url('${nb.customCover}'); border-left:none"` : ""}></div>
                    <div class="nb-title-label">${nb.name}</div>
                </div>`).join('');
        }

        function renderTabs() { 
            document.getElementById('tabs').innerHTML = db.notebooks[curNB].pages.map((pg, i) => `
                <div class="tab ${i===curPG?'active':''}" onclick="switchPG(${i})">${pg.name}</div>`).join(''); 
        }

        function switchPG(i) { saveCur(); curPG = i; loadPG(); renderTabs(); }
        function goToHome() { saveCur(); location.reload(); }
        function updateColorIcon(val) { document.getElementById('color-preview').style.background = val; }

        function openPdfModal() {
            saveCur();
            const list = document.getElementById('pdf-pages-list');
            list.innerHTML = db.notebooks[curNB].pages.map((pg, i) => `
                <label class="pdf-select-item">
                    <input type="checkbox" class="pdf-pg-check" value="${i}" checked>
                    <span>${pg.name}</span>
                </label>
            `).join('');
            document.getElementById('modal-pdf-select').style.display = 'flex';
        }

        function closePdfModal() { document.getElementById('modal-pdf-select').style.display = 'none'; }

        async function processPDF() {
            const selectedIndices = Array.from(document.querySelectorAll('.pdf-pg-check:checked')).map(el => parseInt(el.value));
            if (selectedIndices.length === 0) return alert("Selecione pelo menos uma página.");
            closePdfModal();
            const { jsPDF } = window.jspdf; 
            const pdf = new jsPDF('p', 'mm', 'a4');
            const oldT = paper.style.transform; const oldM = paper.style.marginBottom;
            paper.style.transform = "scale(1)"; paper.style.marginBottom = "0";
            for(let i = 0; i < selectedIndices.length; i++) {
                const pageIdx = selectedIndices[i];
                switchPG(pageIdx); await new Promise(r => setTimeout(r, 600)); 
                const cImg = await html2canvas(document.getElementById('paper-container'), { scale: 2 });
                pdf.addImage(cImg.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, 210, 297);
                if(i < selectedIndices.length - 1) pdf.addPage();
            }
            pdf.save(`${db.notebooks[curNB].name}_selecao.pdf`); 
            paper.style.transform = oldT; paper.style.marginBottom = oldM;
            switchPG(selectedIndices[0]); 
        }

        function openConfig() { document.getElementById('modal-config').style.display = 'flex'; switchConfigTab('manage'); }
        function closeConfig() { document.getElementById('modal-config').style.display = 'none'; }
        
        function switchConfigTab(tab) {
            document.getElementById('config-manage-view').style.display = tab === 'manage' ? 'block' : 'none';
            document.getElementById('config-personalize-view').style.display = tab === 'personalize' ? 'block' : 'none';
            document.getElementById('config-trash-view').style.display = tab === 'trash' ? 'block' : 'none';
            document.getElementById('config-backup-view').style.display = tab === 'backup' ? 'block' : 'none';
            document.querySelectorAll('.m-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            if(tab === 'manage') renderConfigList();
            if(tab === 'trash') renderTrash();
        }

        function renderConfigList() {
            const container = document.getElementById('config-list');
            container.innerHTML = db.notebooks.map((nb, i) => `
                <div class="config-item">
                    <span style="font-weight:700;">${nb.name}</span>
                    <div class="config-actions">
                        <button class="btn btn-accent" onclick="renameNB(${i})">Renomear</button>
                        <button class="btn btn-primary" onclick="triggerCoverInput(${i})">Capa</button>
                        <button class="btn btn-danger" onclick="moveToTrashNB(${i})">Apagar</button>
                    </div>
                </div>`).join('') || "Nenhuma matéria criada.";
        }

        function handleLogoFile(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                db.customLogo = f.target.result;
                document.getElementById('main-logo-img').src = f.target.result;
                saveDB();
            };
            reader.readAsDataURL(file);
        }

        function renameNB(i) { 
            let n = prompt("Novo nome:", db.notebooks[i].name); 
            if(n) { db.notebooks[i].name = n; saveDB(); renderConfigList(); renderHome(); } 
        }
        function triggerCoverInput(i) {
            const input = document.getElementById('coverInput');
            input.setAttribute('data-target-index', i);
            input.click();
        }
        function handleCoverFile(e) {
            const input = e.target;
            const targetIndex = input.getAttribute('data-target-index');
            const file = input.files[0];
            if (!file || targetIndex === null) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                db.notebooks[parseInt(targetIndex)].customCover = f.target.result;
                saveDB(); renderHome(); renderConfigList();
                input.value = "";
            };
            reader.readAsDataURL(file);
        }

        function renderTrash() {
            const container = document.getElementById('trash-list');
            let html = "<h4>Matérias</h4>";
            html += db.trash.notebooks.map((nb, i) => `<div class="trash-item"><span>${nb.name}</span><button class="btn btn-mint" onclick="restoreNB(${i})">Restaurar</button></div>`).join('') || "<p>Vazia</p>";
            html += "<h4>Páginas</h4>";
            html += db.trash.pages.map((item, i) => `<div class="trash-item"><span>${item.pg.name} (de: ${item.sourceNBName})</span><button class="btn btn-mint" onclick="restorePG(${i})">Restaurar</button></div>`).join('') || "<p>Vazia</p>";
            html += `<button class="btn btn-danger" style="width:100%; margin-top:10px" onclick="emptyTrash()">Esvaziar Lixeira</button>`;
            container.innerHTML = html;
        }

        function moveToTrashNB(i) { if(confirm("Mover matéria para lixeira?")) { db.trash.notebooks.push(db.notebooks[i]); db.notebooks.splice(i, 1); saveDB(); renderHome(); renderConfigList(); } }
        function restoreNB(i) { db.notebooks.push(db.trash.notebooks[i]); db.trash.notebooks.splice(i, 1); saveDB(); renderHome(); renderTrash(); }
        function restorePG(i) {
            let item = db.trash.pages[i];
            let nb = db.notebooks.find(n => n.name === item.sourceNBName);
            if(nb) { nb.pages.push(item.pg); db.trash.pages.splice(i, 1); saveDB(); renderTrash(); } else { alert("Matéria original não encontrada."); }
        }
        function emptyTrash() { if(confirm("Apagar permanentemente todos os itens?")) { db.trash = { notebooks: [], pages: [] }; saveDB(); renderTrash(); } }
        function exportBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.setAttribute("href", dataStr); a.setAttribute("download", "backup_odontobook.json"); a.click();
        }
        function importBackup(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); 
            reader.onload = (ev) => { try { db = JSON.parse(ev.target.result); saveDB(); location.reload(); } catch(err) { alert("Arquivo inválido."); } };
            reader.readAsText(file);
        }

        renderHome();
    </script>
</body>
</html>
